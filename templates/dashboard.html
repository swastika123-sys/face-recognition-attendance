<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .navbar-brand img { width: 40px; }
    video, canvas { 
      border: 1px solid #ddd; 
      border-radius: 15px; 
    }
    .dashboard-btn { min-width: 140px; padding: 8px 16px; }
    .ai-output { border-color: #28a745 !important; }
    footer {
      background-color: #212529;
      color: white;
      padding: 20px 0;
      text-align: center;
      margin-top: 60px;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <img src="https://miro.medium.com/v2/resize:fit:2000/1*DPNoWJ3Au35Fw58Sn2oj1w.png" alt="Logo" width="40" height="40" class="rounded-circle me-2"> FaceRecSys
      </a>
      
      <!-- Hamburger toggle button for mobile -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        {% if session.get('user') %}
          <li class="nav-item"><a class="nav-link active" href="{{ url_for('dashboard') }}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('student') }}">Students</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('attendance') }}">Attendance</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('setting') }}">Settings</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('help_page') }}">Help</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('why_choose') }}">Why Choose Us</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('services') }}">Our Services</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('contact') }}">Contact Us</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('help_page') }}">Help</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('register') }}">Register</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

  <!-- Header -->
  <div class="container mt-5 text-center">
    <h2 class="text-primary">Teacher Dashboard</h2>
    <p class="text-muted">Manage your attendance system with ease</p>
  </div>

  <!-- Dashboard Cards -->
  <div class="container mt-4">
    <div class="row g-4 justify-content-center">

      <div class="col-md-3">
        <div class="card text-center p-3 shadow">
          <h4>Manage&nbsp;&nbsp;Students</h4>
          <p>View, add, or edit student details.</p>
          <a href="{{ url_for('student') }}" class="btn btn-primary dashboard-btn">Manage&nbsp;&nbsp;Students</a>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card text-center p-3 shadow">
          <h4>Attendance Records</h4>
          <p>Review attendance logs and export reports.</p>
          <a href="{{ url_for('attendance') }}" class="btn btn-success dashboard-btn">View Attendance</a>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card text-center p-3 shadow">
          <h4>System Settings</h4>
          <p>Configure system preferences and security.</p>
          <a href="{{ url_for('setting') }}" class="btn btn-dark dashboard-btn">System Settings</a>
        </div>
      </div>

      <!-- Face Attendance Section -->
      <div class="col-md-12">
        <div class="card text-center p-3 shadow">
          <h4>Mark Attendance</h4>
          <p>Scan your face to mark your attendance.</p>
          
          <!-- Camera Container with two feeds -->
          <div class="row justify-content-center">
            <!-- Input Camera Feed -->
            <div class="col-md-6">
              <div class="position-relative d-inline-block" style="border: 2px solid #ddd; border-radius: 15px; overflow: hidden;">
                <video id="video" width="400" height="300" style="display: none; border-radius: 15px;"></video>
                <canvas id="canvas" width="400" height="300" style="background: #f8f9fa; display: block; border-radius: 15px;"></canvas>
                <div id="cameraPlaceholder" class="d-flex align-items-center justify-content-center" style="width: 400px; height: 300px; background: #f8f9fa; color: #6c757d; border-radius: 15px;">
                  <div class="text-center">
                    <p class="mt-2">Click Start Camera</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- AI Detection Output -->
            <div class="col-md-6">
              <div class="position-relative d-inline-block" style="border: 2px solid #28a745; border-radius: 15px; overflow: hidden;">
                <canvas id="outputCanvas" width="400" height="300" style="background: #f8f9fa; border-radius: 15px;"></canvas>
                <div id="outputPlaceholder" class="d-flex align-items-center justify-content-center" style="width: 400px; height: 300px; background: #f8f9fa; color: #6c757d; border-radius: 15px;">
                  <div class="text-center">
                    <p class="mt-2">Detection output will appear here</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Controls -->
          <div class="mt-3">
            <button id="startCameraBtn" class="btn btn-success me-2" onclick="startCamera()">
              <i class="bi bi-camera-video"></i> Start Camera
            </button>
            <button id="stopCameraBtn" class="btn btn-danger me-2" onclick="stopCamera()" style="display: none;">
              <i class="bi bi-camera-video-off"></i> Stop Camera
            </button>
            <button id="scanBtn" class="btn btn-warning" onclick="captureAndSend()" style="display: none;">
              <i class="bi bi-search"></i> Scan & Submit
            </button>
          </div>
          
          <!-- Result Message -->
          <div id="result" class="mt-3"></div>
        </div>
      </div>

    </div>

    <div class="text-center mt-4">
      <a href="{{ url_for('services') }}" class="btn btn-primary">Back to Services ↩️</a>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>© 2025 FaceRecSys | AI-Powered Attendance for Smart Institutions</p>
  </footer>

  <!-- Webcam + JS -->
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const outputCanvas = document.getElementById('outputCanvas');
    const outputCtx = outputCanvas.getContext('2d');
    const result = document.getElementById('result');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const outputPlaceholder = document.getElementById('outputPlaceholder');
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const scanBtn = document.getElementById('scanBtn');
    
    let stream = null;
    let isScanning = false;
    let detectionInterval = null;
    let currentFaceCount = 0;

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          width: 400, 
          height: 300,
          facingMode: 'user'
        } 
      })
      .then(mediaStream => {
        stream = mediaStream;
        video.srcObject = stream;
        
        // Hide placeholders, show canvases
        cameraPlaceholder.style.display = 'none';
        outputPlaceholder.style.display = 'none';
        canvas.style.display = 'block';
        outputCanvas.style.display = 'block';
        
        // Update button states
        startCameraBtn.style.display = 'none';
        stopCameraBtn.style.display = 'inline-block';
        scanBtn.style.display = 'inline-block';
        
        // Start video processing when metadata is loaded
        video.addEventListener('loadedmetadata', () => {
          video.play();
          drawVideoFrame();
          startFaceDetection();
        });
        
        clearResult();
      })
      .catch(err => {
        showResult("⚠️ Camera access denied or not available.", "danger");
        console.error(err);
      });
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      // Stop face detection
      if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
      }
      
      // Hide canvases, show placeholders
      canvas.style.display = 'none';
      outputCanvas.style.display = 'none';
      cameraPlaceholder.style.display = 'flex';
      outputPlaceholder.style.display = 'flex';
      
      // Update button states
      startCameraBtn.style.display = 'inline-block';
      stopCameraBtn.style.display = 'none';
      scanBtn.style.display = 'none';
      
      // Clear canvases
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      outputCtx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
      clearResult();
    }

    function drawVideoFrame() {
      if (video.readyState === video.HAVE_ENOUGH_DATA && stream) {
        // Draw video frame to input canvas (clean)
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Continue drawing frames
        requestAnimationFrame(drawVideoFrame);
      }
    }

    function startFaceDetection() {
      // Detect faces every 500ms
      detectionInterval = setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA && stream && !isScanning) {
          detectFacesInFrame();
        }
      }, 500);
    }

    function detectFacesInFrame() {
      // Capture current frame for detection
      const detectionCanvas = document.createElement('canvas');
      detectionCanvas.width = video.videoWidth;
      detectionCanvas.height = video.videoHeight;
      const detectionCtx = detectionCanvas.getContext('2d');
      detectionCtx.drawImage(video, 0, 0, detectionCanvas.width, detectionCanvas.height);
      const dataURL = detectionCanvas.toDataURL('image/png');

      fetch('/detect_face', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: dataURL })
      })
      .then(res => res.json())
      .then(data => {
        console.log('Face detection response:', data); // Debug log
        
        // Update current face count from detection results
        currentFaceCount = data.total_faces || 0;
        console.log('Updated currentFaceCount to:', currentFaceCount); // Debug log
        
        // Draw AI detection output with face boxes
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          // Copy video frame to output canvas
          outputCtx.drawImage(video, 0, 0, outputCanvas.width, outputCanvas.height);
          
          // Draw face detection boxes on output canvas
          if (data.faces && data.faces.length > 0) {
            console.log('Drawing face boxes for faces:', data.faces); // Debug log
            drawFaceBoxes(data.faces, outputCtx, outputCanvas);
          } else {
            // Clear output canvas when no faces detected
            outputCtx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
          }
        }
      })
      .catch(err => {
        console.error('Face detection error:', err);
      });
    }

    function drawFaceBoxes(faces, context, canvasElement) {
      faces.forEach(face => {
        // The backend already returns coordinates for a 400x300 image
        // We need to scale these to our canvas size
        const scaleX = canvasElement.width / 400;  // Backend thumbnail width
        const scaleY = canvasElement.height / 300; // Backend thumbnail height
        
        const x = face.x * scaleX;
        const y = face.y * scaleY;
        const width = face.width * scaleX;
        const height = face.height * scaleY;
        
        console.log(`Drawing face box: x=${x}, y=${y}, w=${width}, h=${height}, scaleX=${scaleX}, scaleY=${scaleY}`);
        
        // Draw different colored boxes based on status
        if (face.status === 'registered') {
          context.strokeStyle = '#28a745'; // Green for registered
          context.fillStyle = 'rgba(40, 167, 69, 0.2)';
        } else {
          context.strokeStyle = '#ffc107'; // Yellow for unregistered
          context.fillStyle = 'rgba(255, 193, 7, 0.2)';
        }
        
        context.lineWidth = 4;
        context.strokeRect(x, y, width, height);
        
        // Draw name/status background
        const text = face.status === 'registered' ? face.display_name : 'UNREGISTERED';
        context.font = 'bold 14px Arial';
        const textWidth = context.measureText(text).width;
        const textPadding = 8;
        
        // Background for text (above the face box)
        context.fillStyle = face.status === 'registered' ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)';
        context.fillRect(x, y - 30, textWidth + textPadding * 2, 25);
        
        // Text
        context.fillStyle = 'white';
        context.fillText(text, x + textPadding, y - 10);
      });
    }

    function captureAndSend() {
      if (isScanning) return;
      
      // Check if multiple faces are currently detected
      if (currentFaceCount > 1) {
        showResult(`⚠️ Multiple faces detected (${currentFaceCount}). Please ensure only one person is in the frame.`, "warning");
        return;
      }
      
      if (currentFaceCount === 0) {
        showResult("⚠️ No face detected. Please position yourself in front of the camera.", "warning");
        return;
      }
      
      isScanning = true;
      scanBtn.disabled = true;
      scanBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Scanning...';
      
      // Capture current frame from output canvas (with AI detection)
      const dataURL = outputCanvas.toDataURL('image/png');

      fetch('/recognize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: dataURL })
      })
      .then(res => res.json())
      .then(data => {
        console.log('Recognition response:', data);
        
        if (data.error) {
          if (data.multiple_faces) {
            showResult("⚠️ " + data.error, "warning");
          } else {
            showResult("⚠️ Error: " + data.error, "danger");
          }
        } else if (data.success && data.recognized) {
          showResult("✅ " + data.message, "success");
        } else {
          showResult("❌ " + data.message, "danger");
        }
      })
      .catch(err => {
        showResult("⚠️ Connection error: " + err.message, "danger");
        console.error('Error:', err);
      })
      .finally(() => {
        isScanning = false;
        scanBtn.disabled = false;
        scanBtn.innerHTML = '<i class="bi bi-search"></i> Scan & Submit';
      });
    }

    function showResult(message, type) {
      result.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : 'warning'} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
    }

    function clearResult() {
      result.innerHTML = '';
    }

    // Auto-dismiss alerts after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
      setInterval(() => {
        const alerts = result.querySelectorAll('.alert');
        alerts.forEach(alert => {
          if (alert.classList.contains('show')) {
            setTimeout(() => {
              if (alert.parentNode) {
                alert.remove();
              }
            }, 5000);
          }
        });
      }, 1000);
    });
  </script>
  
  <!-- Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>